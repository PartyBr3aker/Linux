# Сети в Linux

Настройка сетей в Linux на виртуальных машинах.

## Contents

1. [Сети в Linux](#Linux-network) \
   1.1. [Инструмент ipcalc](#part-1-инструмент-ipcalc) \
   1.2. [Статическая маршрутизация между двумя машинами](#part-2-статическая-маршрутизация-между-двумя-машинами) \
   1.3. [Утилита iperf3](#part-3-утилита-iperf3) \
   1.4. [Сетевой экран](#part-4-сетевой-экран) \
   1.5. [Статическая маршрутизация сети](#part-5-статическая-маршрутизация-сети) \
   1.6. [Динамическая настройка IP с помощью DHCP](#part-6-динамическая-настройка-ip-с-помощью-dhcp) \
   1.7. [NAT](#part-7-nat) \
   1.8. [Допополнительно. Знакомство с SSH Tunnels](#part-8-дополнительно-знакомство-с-ssh-tunnels)

## Linux network

В качестве результата работы должен быть предоставлен отчет по выполненным задачам. В каждой части задания указано, что должно быть помещено в отчёт, после её выполнения. Это могут быть ответы на вопросы, скриншоты и т.д.

- В репозиторий, в папку src, должен быть загружен отчёт с расширением .md.
- В отчёте должны быть выделены все части задания, как заголовки 2-го уровня.
- В рамках одной части задания всё, что помещается в отчёт, должно быть оформлено в виде списка.
- Каждый скриншот в отчёте должен быть кратко подписан (что показано на скриншоте).
- Все скриншоты обрезаны так, чтобы была видна только нужная часть экрана.
- На одном скриншоте допускается отображение сразу нескольких пунктов задания, но они все должны быть описаны в подписи к скриншоту.
- На все виртуальные машины, созданные в процессе выполнения задания, устанавливать **Ubuntu 20.04 Server LTS**

## Part 1. Инструмент **ipcalc**

**== Задание ==**

### Поднять виртуальную машину (далее -- ws1)

### 1.1. Сети и маски

#### Определить и записать в отчёт

#### 1) Адрес сети *192.167.38.54/13*

#### 2) Перевод маски *255.255.255.0* в префиксную и двоичную запись, */15* в обычную и двоичную, *11111111.11111111.11111111.11110000* в обычную и префиксную

#### 3) Минимальный и максимальный хост в сети *12.167.38.4* при масках: */8*, *11111111.11111111.00000000.00000000*, *255.255.254.0* и */4*

### 1.2. localhost

#### Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: *194.34.23.100*, *127.0.0.2*, *127.1.0.1*, *128.0.0.1*

### 1.3. Диапазоны и сегменты сетей

### Определить и записать в отчёт

#### 1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: *10.0.0.45*, *134.43.0.2*, *192.168.4.2*, *172.20.250.4*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *172.16.255.255*, *10.10.10.10*, *192.169.168.1*

#### 2) какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*: *10.0.0.1*, *10.10.0.2*, *10.10.10.10*, *10.10.100.1*, *10.10.1.255*

**== Ответ ==**

### 1.1. Сети и маски

#### 1) Адрес сети *192.167.38.54/13*

- ipcalc 192.167.38.54/13
![net_address](/misc/images/report_images/1_1.png)
- Согласно выводу, адрес сети 192.160.0.0/13

#### 2) Перевод маски *255.255.255.0* в префиксную и двоичную запись, */15* в обычную и двоичную, *11111111.11111111.11111111.11110000* в обычную и префиксную

- ipcalc 255.255.255.0
  
![ipcalc /24](/misc/images/report_images/1_2.png)

  Согласно выводу:
  
  Префиксная запись: \24
  
  Двоичная запись: 11111111.11111111.11111111.00000000

- ipcalc /15
  ![ipcalc /15](/misc/images/report_images/1_3.png)
  Согласно выводу:

  Обычная запись: 255.254.0.0
  
  Двоичная запись: 11111111.11111110.00000000. 00000000
- ipcalc не принимает данные в двоичном формате
  
  Обычная запись: 255.255.255.240

  Префиксная запись: \28

#### 3) Минимальный и максимальный хост в сети *12.167.38.4* при масках: */8*, *11111111.11111111.00000000.00000000*, *255.255.254.0* и */4*

- ipcalc 12.167.38.4/8
 ![ipcalc /8](/misc/images/report_images/1_4.png)
- ipcalc 12.167.38.4/255.255.0.0
  ![ipcalc /16](/misc/images/report_images/1_5.png)
- ipcalc 12.167.38.4/255.255.254.0
  ![ipcalc /23](/misc/images/report_images/1_6.png)
- ipcalc 12.167.38.4/4
  ![ipcalc /4](/misc/images/report_images/1_7.png)

### 1.2. localhost

- *194.34.23.100* нельзя
  ![class c no loopback](/misc/images/report_images/1_8.png)
- *127.0.0.2* можно
   ![class a loopback](/misc/images/report_images/1_9.png)
- *127.1.0.1* можно
  ![class a loopback](/misc/images/report_images/1_10.png)
- *128.0.0.1* нельзя
  ![class b no loopback](/misc/images/report_images/1_11.png)

### 1.3. Диапазоны и сегменты сетей

#### 1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 

- *10.0.0.45* только частная
   ![class a private](/misc/images/report_images/1_12.png)
- *134.43.0.2* можно использовать в качестве публичного
  ![class B public](/misc/images/report_images/1_13.png)
- *192.168.4.2* только частная
  ![class C private](/misc/images/report_images/1_14.png)
  
- *172.20.250.4* только частная
  ![class B private](/misc/images/report_images/1_15.png)

- *172.0.2.1* можно использовать в качестве публичного
  ![class B](/misc/images/report_images/1_16.png)
  
- *192.172.0.1* можно использовать в качестве публичного
  ![class c](/misc/images/report_images/1_17.png)
  
- *172.68.0.2* можно использовать в качестве публичного
  ![class B](/misc/images/report_images/1_18.png)
  
- *172.16.255.255* только частная
  ![class B private](/misc/images/report_images/1_19.png)
  
- *10.10.10.10* только частная
  ![class A private](/misc/images/report_images/1_20.png)
  
- *192.169.168.1* можно использовать в качестве публичного
  ![class C](/misc/images/report_images/1_21.png)
  

#### 2) какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*: 

  ![check for hosts 10.10.0.0/18](/misc/images/report_images/1_22.png)

- *10.0.0.1* нет
- *10.10.0.2* да
- *10.10.10.10* да
- *10.10.100.1* нет
- *10.10.1.255* да
  
## Part 2. Статическая маршрутизация между двумя машинами


**== Задание ==**

##### Поднять две виртуальные машины (далее -- ws1 и ws2)

##### С помощью команды `ip a` посмотреть существующие сетевые интерфейсы

- В отчёт поместить скрин с вызовом и выводом использованной команды.

##### Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - *192.168.100.10*, маска */16*, ws2 - *172.24.116.8*, маска */12*

- В отчёт поместить скрины с содержанием изменённого файла *etc/netplan/00-installer-config.yaml* для каждой машины.

##### Выполнить команду `netplan apply` для перезапуска сервиса сети

- В отчёт поместить скрин с вызовом и выводом использованной команды.

#### 2.1. Добавление статического маршрута вручную

##### Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`

##### Пропинговать соединение между машинами

- В отчёт поместить скрин с вызовом и выводом использованных команд.

#### 2.2. Добавление статического маршрута с сохранением

##### Перезапустить машины

##### Добавить статический маршрут от одной машины до другой с помощью файла *etc/netplan/00-installer-config.yaml*

- В отчёт поместить скрин с содержанием изменённого файла *etc/netplan/00-installer-config.yaml*.

##### Пропинговать соединение между машинами

- В отчёт поместить скрин с вызовом и выводом использованной команды.

**== Ответ ==**

- ip a

  WS1:

  ![ip -a base](/misc/images/report_images/2_1.png)

  WS2:

  ![ip -a clone](/misc/images/report_images/2_2.png)

- /etc/netplan/00-installer-config.yaml file
  
  WS1:

 ![netplan base](/misc/images/report_images/2_3.png)

  WS2:

 ![netplan clone](/misc/images/report_images/2_4.png)

- sudo netplan apply
  
 WS1:

 ![netplan apply base](/misc/images/report_images/2_6.png)

 WS2:

 ![netplan apply clone](/misc/images/report_images/2_5.png)

#### 2.1. Добавление статического маршрута вручную

- ip r add [address we want to connect to] dev [network name]
 
 WS1:

 ![ip r base](/misc/images/report_images/2_1_1.png)

 WS2:

 ![ip r clone](/misc/images/report_images/2_1_2.png)

#### 2.2. Добавление статического маршрута с сохранением

 WS1:

 ![new netplan base](/misc/images/report_images/2_2_1.png)

 ![ping base](/misc/images/report_images/2_2_3.png)

 WS2:

 ![new netplan clone](/misc/images/report_images/2_2_2.png)

 ![ping clone](/misc/images/report_images/2_2_4.png)

## Part 3. Утилита **iperf3**

**== Задание ==**

#### 3.1. Скорость соединения

##### Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps

#### 3.2. Утилита **iperf3**

##### Измерить скорость соединения между ws1 и ws2


**== Ответ ==**

#### 3.1. Скорость соединения

- 8 Mbps в MB/s = 1MB/s
  
- 100 MB/s в Kbps = 819 200 Kbps
  
- 1 Gbps в Mbps = 1024 Mbps

#### 3.2. Утилита **iperf3**

WS1 в режиме проверочного сервера iperf3 -s:

 ![iperf3 -s base](/misc/images/report_images/3_1.png)

WS2 в режиме клиента тестирования iperf3 -c:

 ![iperf3 -c clone](/misc/images/report_images/3_2.png)


## Part 4. Сетевой экран

**== Задание ==**

#### 4.1. Утилита **iptables**

##### Создать файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2

```shell
#!/bin/sh

# Удаление всех правил в таблице "filter" (по-умолчанию).
iptables –F
iptables -X
```

##### Нужно добавить в файл подряд следующие правила

##### 1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)

##### 2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)

##### 3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)

##### 4) запретить *echo reply* (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)

##### 5) разрешить *echo reply* (машина должна "пинговаться")

- В отчёт поместить скрины с содержанием файла */etc/firewall* для каждой машины.

##### Запустить файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`

- В отчёт поместить скрины с запуском обоих файлов.
- В отчёте описать разницу между стратегиями, применёнными в первом и втором файлах.

#### 4.2. Утилита **nmap**

##### Командой **ping** найти машину, которая не "пингуется", после чего утилитой **nmap** показать, что хост машины запущен

*Проверка: в выводе nmap должно быть сказано: `Host is up`*

- В отчёт поместить скрины с вызовом и выводом использованных команд **ping** и **nmap**.

**== Ответ ==**

#### 4.1. Утилита **iptables**

- Создан файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2
  WS1:

 ![firewall base](/misc/images/report_images/4_1.png)

 ![ping base](/misc/images/report_images/4_3.png)

 WS2:

 ![firewall clone](/misc/images/report_images/4_2.png)

 ![ping clone](/misc/images/report_images/4_4.png)

- Разница между стратегиями:
 В 1-й стратегии первое правило запрещающее, а потом попытка перезаписать разрешающим правилом. (Но этого не происходит, потому что перезаписывать нельзя)
 Во 2-й стратегии первое правило разрешающее, а потом запрещающее (Но этого не происходит, потому что перезаписывать нельзя)

#### 4.2. Утилита **nmap**

 ![ping and nmap](/misc/images/report_images/4_5.png)

## Part 5. Статическая маршрутизация сети

**== Задание ==**

Сеть: \
<img src="../misc/images/part5_network.png" alt="part5_network" width="500"/>

##### Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))

#### 5.1. Настройка адресов машин

##### Настроить конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке

- В отчёт поместить скрины с содержанием файла *etc/netplan/00-installer-config.yaml* для каждой машины.

##### Перезапустить сервис сети. Если ошибок нет, то командой `ip -4 a` проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11

- В отчёт поместить скрины с вызовом и выводом использованных команд.

#### 5.2. Включение переадресации IP-адресов

##### Для включения переадресации IP, выполните команду на роутерах

`sysctl -w net.ipv4.ip_forward=1`
*При таком подходе переадресация не будет работать после перезагрузки системы.*

- В отчёт поместить скрин с вызовом и выводом использованной команды.

##### Откройте файл */etc/sysctl.conf* и добавьте в него следующую строку

`net.ipv4.ip_forward = 1`
*При использовании этого подхода, IP-переадресация включена на постоянной основе.*

- В отчёт поместить скрин с содержанием изменённого файла */etc/sysctl.conf*.

#### 5.3. Установка маршрута по-умолчанию

Пример вывода команды `ip r` после добавления шлюза:

```
default via 10.10.0.1 dev eth0
10.10.0.0/18 dev eth0 proto kernel scope link src 10.10.0.2
```

##### Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить `default` перед IP роутера в файле конфигураций

- В отчёт поместить скрин с содержанием файла *etc/netplan/00-installer-config.yaml*.

##### Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации

- В отчёт поместить скрин с вызовом и выводом использованной команды.

##### Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду

`tcpdump -tn -i eth1`

- В отчёт поместить скрин с вызовом и выводом использованных команд.

#### 5.4. Добавление статических маршрутов

##### Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26

```shell
# Добавить в конец описания сетевого интерфейса eth1:
- to: 10.20.0.0
  via: 10.100.0.12
```

- В отчёт поместить скрины с содержанием изменённого файла *etc/netplan/00-installer-config.yaml* для каждого роутера.

##### Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах. Пример таблицы на r1

```
10.100.0.0/16 dev eth1 proto kernel scope link src 10.100.0.11
10.20.0.0/26 via 10.100.0.12 dev eth1
10.10.0.0/18 dev eth0 proto kernel scope link src 10.10.0.1
```

- В отчёт поместить скрин с вызовом и выводом использованной команды.

##### Запустить команды на ws11

`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`

- В отчёт поместить скрин с вызовом и выводом использованных команд.
- В отчёте объяснить, почему для адреса 10.10.0.0/\[маска сети\] был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию.

#### 5.5. Построение списка маршрутизаторов

Пример вывода утилиты **traceroute** после добавления шлюза:

```
1 10.10.0.1 0 ms 1 ms 0 ms
2 10.100.0.12 1 ms 0 ms 1 ms
3 10.20.0.10 12 ms 1 ms 3 ms
```

##### Запустить на r1 команду дампа

`tcpdump -tnv -i eth0`

##### При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21

- В отчёт поместить скрины с вызовом и выводом использованных команд (tcpdump и traceroute).
- В отчёте, опираясь на вывод, полученный из дампа на r1, объяснить принцип работы построения пути при помощи **traceroute**.

#### 5.6. Использование протокола **ICMP** при маршрутизации

##### Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды

`tcpdump -n -i eth0 icmp`

##### Пропинговать с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды

`ping -c 1 10.30.0.111`

- В отчёт поместить скрин с вызовом и выводом использованных команд.

**== Ответ ==**

#### 5.1. Настройка адресов машин

##### Настроить конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке

- r1

 ![netplan r1](/misc/images/report_images/5_1_1.png)
 ![netplan r1 apply](/misc/images/report_images/5_0_1.png)

- r2

 ![netplan r2](/misc/images/report_images/5_1_2.png)
 ![netplan r2 apply](/misc/images/report_images/5_0_2.png)

- ws11

 ![netplan ws11](/misc/images/report_images/5_1_3.png)
 ![netplan ws11 apply](/misc/images/report_images/5_0_3.png)

- ws21

 ![netplan ws21](/misc/images/report_images/5_1_4.png)
 ![netplan ws21 apply](/misc/images/report_images/5_0_4.png)

- ws22

 ![netplan ws22](/misc/images/report_images/5_1_5.png)
 ![netplan ws22 apply](/misc/images/report_images/5_0_5.png)

- ip -4 a r1

 ![ip r1](/misc/images/report_images/5_1_9.png)

- ip -4 a r2

 ![ip r2](/misc/images/report_images/5_1_10.png)

- ip -4 a ws11

 ![ip ws11](/misc/images/report_images/5_1_11.png)

- ip -4 a ws21

 ![ip ws21](/misc/images/report_images/5_1_12.png)

- ip -4 a ws22

 ![ip ws22](/misc/images/report_images/5_1_13.png)

- ping ws22

 ![ping ws22](/misc/images/report_images/5_1_6.png)

- ping ws21

 ![ping ws21](/misc/images/report_images/5_1_7.png)

- ping ws11

 ![ping ws11](/misc/images/report_images/5_1_8.png)

#### 5.2. Включение переадресации IP-адресов

- sudo sysctl -w net.ipv4.ip_forward=1 r1

 ![ip_forward=1 r1](/misc/images/report_images/5_2_1.png)

- sudo sysctl -w net.ipv4.ip_forward=1 r2

 ![ip_forward=1 r2](/misc/images/report_images/5_2_2.png)

- sudo vim /etc/sysctl.conf r1

 ![ip r1](/misc/images/report_images/5_2_4.png)

- sudo vim /etc/sysctl.conf r2

 ![ip r2](/misc/images/report_images/5_2_3.png)

#### 5.3. Установка маршрута по-умолчанию

- netplan w11
  
   ![netplan w11](/misc/images/report_images/5_1_3.png)

- ip r w11

 ![ip r w11](/misc/images/report_images/5_3_1.png)

- netplan w21
  
   ![netplan w21](/misc/images/report_images/5_1_4.png)

- ip r w21

 ![ip r w21](/misc/images/report_images/5_3_2.png)

- netplan w22
  
   ![netplan w22](/misc/images/report_images/5_1_5.png)

- ip r w22

 ![ip r w22](/misc/images/report_images/5_3_3.png)

- ping from w11 to r2

 ![ping w 11](/misc/images/report_images/5_3_4.png)

- sudo tcpdump -tn -i enp0s8 r2
  
 ![listen r2](/misc/images/report_images/5_3_5.png)

#### 5.4. Добавление статических маршрутов

- netplan r1
  
 ![netplan r1](/misc/images/report_images/5_1_1.png)

- ip r r1
  
 ![ip r r1](/misc/images/report_images/5_4_1.png)

- netplan r2
  
 ![netplan r2](/misc/images/report_images/5_1_2.png)

- ip r r2
  
 ![ip r r2](/misc/images/report_images/5_4_2.png)

- ip r list 10.10.0.0/18 ws11
  
![ip r list](/misc/images/report_images/5_4_3.png)

- ip r list 0.0.0.0/0

![ip r list](/misc/images/report_images/5_4_4.png)

- Маршрут 10.10.0.0/18 был выбран так как роутер никогда не выбирает маршрут по умолчанию при наличии альтернативы в целях увеличения точности маршрута (правило самой длинной маски)

#### 5.5. Построение списка маршрутизаторов

- sudo tcpdump -n -i enp0s8 icmp
  
![tcpdump r1](/misc/images/report_images/5_5_11.png)

- sudo traceroute 10.20.0.10

![ws11 traceroute to ws21](/misc/images/report_images/5_5_22.png)

- Объяснение

![Схема](/misc/images/report_images/5_5_3.png)

Traceroute основана на отправке udp фрагментов и получения сообщения о доступности/недостижимости порта.
Host генерирует udp фрагмент, инкапсулирует его в IP пакет и выставляет ttl=1. Router1, являясь транзитным узлом, ответит на данный пакет icmp сообщением об окончании времени жизни пакета. Утилита traceroute, получив данное сообщение, указывает адрес источника icmp пакета (Router1) как адрес первого хопа.
Далее процесс повторяется с инкрементированием ttl пакета.

Как утилита traceroute поймет, что трассировка закончена? 

- в udp заголовке есть поля source и destination порт. Source порт будет любым портом выше 1023.
- udp фрагмент отправляется с порта 45000 ( к примеру) на порт 33434 (именно этот порт используется по умолчанию).
- Server1 является узлом назначения. Получив пакет, он распаковывает его и должен передать его протоколам высшего уровня. Но так как порт 33434 по умолочанию будет закрыт на сервере, то Server1 формирует icmp сообщение о недостижимости порта назначения (ICMP Type 3 «Destination Unreachable» Code 3 «Port Unreachable»).
- Получив данное сообщение, утилита traceroute считает трассировку законченной.
- В процессе трассировки номер порта назначения будет инкрементироваться при каждой попытке ( 33434, 33435 и т д). Может получится так, что порт назначения будет открыт. В данном случае сервер отправит на хост-инициатор например TCP ACK если для трассировки используются TCP SYN пакеты, что тоже будет являться триггером к окончанию трассировки.

#### 5.6. Использование протокола **ICMP** при маршрутизации

- sudo tcpdump -n -i enp0s8 icmp
  
![tcpdump r1](/misc/images/report_images/5_6_2.png)

- ping -c 1 10.100.0.15 ws11

![ping -c 1 10.100.0.15](/misc/images/report_images/5_6_1.png)
  
## Part 6. Динамическая настройка IP с помощью **DHCP**

**== Задание ==**

### Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**

#### 1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. Пример файла для r2

```shell
subnet 10.100.0.0 netmask 255.255.0.0 {}

subnet 10.20.0.0 netmask 255.255.255.192
{
    range 10.20.0.2 10.20.0.50;
    option routers 10.20.0.1;
    option domain-name-servers 10.20.0.1;
}
```

#### 2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`

- В отчёт поместить скрины с содержанием изменённых файлов.

### Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21

- В отчёт поместить скрины с вызовом и выводом использованных команд.

### Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`

- В отчёт поместить скрин с содержанием изменённого файла *etc/netplan/00-installer-config.yaml*.

### Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

- В отчёте этот пункт описать аналогично настройке для r2.

### 1. Запросить с ws21 обновление ip адреса

- В отчёте поместить скрины ip до и после обновления.
- В отчёте описать, какими опциями **DHCP** сервера пользовались в данном пункте.

**== Ответ ==**

#### Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**

- sudo apt install isc-dhcp-server

#### 1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.

![dhcp.conf](/misc/images/report_images/6_1.png)

#### 2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`

![resolv.conf](/misc/images/report_images/6_2.png)

### Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21

- systemctl restart isc-dhcp-server
  
![restart dhcp](/misc/images/report_images/6_3.png)

- sudo reboot now
  
![reboot](/misc/images/report_images/6_4.png)

- ip a
  
![ip a](/misc/images/report_images/6_5.png)

- ping 10.20.0.20

![ping](/misc/images/report_images/6_6.png)


### Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`

- netplan

![netplan](/misc/images/report_images/6_7.png)
![apply](/misc/images/report_images/6_8.png)

### Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

- sudo apt install isc-dhcp-server

#### 1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.

![dhcp.conf](/misc/images/report_images/6_9.png)

#### 2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`

![resolv.conf](/misc/images/report_images/6_10.png)

### Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21

- systemctl restart isc-dhcp-server
  
![restart dhcp](/misc/images/report_images/6_11.png)

- sudo reboot now
  
![reboot](/misc/images/report_images/6_12.png)

- ip a
  
![ip a](/misc/images/report_images/6_13.png)

- ping 10.10.0.1

![ping](/misc/images/report_images/6_15.png)

### Запросить с ws21 обновление ip адреса

- sudo dhclient -r enp0s8
- sudo dhclient enp0s8

![dhclient enp0s8](/misc/images/report_images/6_14.png)

- В отчёте описать, какими опциями **DHCP** сервера пользовались в данном пункте.
  - Вариант 3 — шлюз по умолчанию;
  - Вариант 6 - Адрес DNS-сервера (основной и резервный);


## Part 7. **NAT**


**== Задание ==**

##### В файле */etc/apache2/ports.conf* на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным

- В отчёт поместить скрин с содержанием изменённого файла.

##### Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1

- В отчёт поместить скрины с вызовом и выводом использованной команды.

##### Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила

##### 1) Удаление правил в таблице filter - `iptables -F`

##### 2) Удаление правил в таблице "NAT" - `iptables -F -t nat`

##### 3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`

##### Запускать файл также, как в Части 4

##### Проверить соединение между ws22 и r1 командой `ping`

*При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1*

- В отчёт поместить скрины с вызовом и выводом использованной команды.

##### Добавить в файл ещё одно правило

##### 4) Разрешить маршрутизацию всех пакетов протокола **ICMP**

##### Запускать файл также, как в Части 4

##### Проверить соединение между ws22 и r1 командой `ping`

*При запуске файла с этими правилами, ws22 должна "пинговаться" с r1*

- В отчёт поместить скрины с вызовом и выводом использованной команды.

##### Добавить в файл ещё два правила

##### 5) Включить **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)

*Совет: стоит подумать о маршрутизации внутренних пакетов, а также внешних пакетов с установленным соединением*

##### 6) Включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

*Совет: стоит учесть, что при попытке подключения возникнет новое tcp-соединение, предназначенное ws22 и 80 порту*

- В отчёт поместить скрин с содержанием изменённого файла.

##### Запускать файл также, как в Части 4

*Перед тестированием рекомендуется отключить сетевой интерфейс **NAT** (его наличие можно проверить командой `ip a`) в VirtualBox, если он включен*

##### Проверить соединение по TCP для **SNAT**, для этого с ws22 подключиться к серверу Apache на r1 командой

`telnet [адрес] [порт]`

##### Проверить соединение по TCP для **DNAT**, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080)

- В отчёт поместить скрины с вызовом и выводом использованных команд.

**== Ответ==**

##### В файле */etc/apache2/ports.conf* на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным

- sudo apt install apache2
  
- /etc/apache2/ports.conf
  
  ![ports.conf](/misc/images/report_images/7_1.png)

##### Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1

- r1
  
  ![apache](/misc/images/report_images/7_2.png)

- ws22
  
  ![apache](/misc/images/report_images/7_3.png)


##### Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила

##### 1) Удаление правил в таблице filter - `iptables -F`

##### 2) Удаление правил в таблице "NAT" - `iptables -F -t nat`

##### 3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`

![firewall](/misc/images/report_images/7_4.png)

##### Запускать файл также, как в Части 4

![firewall](/misc/images/report_images/7_5.png)

##### Проверить соединение между ws22 и r1 командой `ping`

- до запуска firewall.sh

![ping before](/misc/images/report_images/7_6.png)

- после запуска

![ping after](/misc/images/report_images/7_7.png)

##### Добавить в файл ещё одно правило

##### 4) Разрешить маршрутизацию всех пакетов протокола **ICMP**

![icmp enable](/misc/images/report_images/7_8.png)

##### Запускать файл также, как в Части 4

![activate new firewall](/misc/images/report_images/7_5.png)

##### Проверить соединение между ws22 и r1 командой `ping`

- ping r1

![ping r1](/misc/images/report_images/7_9.png)

- ping ws22
  
![ping ws22](/misc/images/report_images/7_10.png) 

##### Добавить в файл ещё два правила

##### 5) Включить **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)


##### 6) Включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

![DNAT SNAT](/misc/images/report_images/7_11.png)

  Значения использованных опций:

- t - указывает на используемую таблицу;
  
- p - указывает протокол, такие как tcp, udp, udplite и другие, поддерживаемые системой, ознакомиться со списком можно в файле /etc/protocols;
  
- m - подключает указанный модуль;
  
- s - указывает адрес источника пакета, в качестве значения можно указать как один IP-адрес, так и диапазон;
  
- i - задает входящий сетевой интерфейс;
  
- o - указывает исходящий сетевой интерфейс;
  
- --dport - порт получателя пакета;
  
- DNAT — подменяет адрес получателя в заголовке IP-пакета, основное применение — предоставление доступа к сервисам снаружи, находящимся внутри сети;
  
- SNAT — служит для преобразования сетевых адресов, применимо, когда за сервером находятся машины, которым необходимо предоставить доступ в Интернет, при этом от провайдера имеется статический IP-адрес.

##### Запускать файл также, как в Части 4

![activate new firewall](/misc/images/report_images/7_5.png)

##### Проверить соединение по TCP для **SNAT**, для этого с ws22 подключиться к серверу Apache на r1 командой

![telnet r1](/misc/images/report_images/7_12.png)

#### Проверить соединение по TCP для **DNAT**, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080)

![telnet r2](/misc/images/report_images/7_13.png)

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

**== Задание ==**

##### Запустить на r2 фаервол с правилами из Части 7

##### Запустить веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* изменить строку `Listen 80` на `Listen localhost:80`)

##### Воспользоваться *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

##### Воспользоваться *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

##### Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду

`telnet 127.0.0.1 [локальный порт]`

- В отчёте описать команды, необходимые для выполнения этих четырёх пунктов, а также приложить скриншоты с их вызовом и выводом.

**== Ответ ==**


##### Запустить на r2 фаервол с правилами из Части 7

![firewall r2](/misc/images/report_images/7_5.png)

##### Запустить веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* изменить строку `Listen 80` на `Listen localhost:80`)

- update ports.conf

![ports.conf](/misc/images/report_images/8_1.png)

![apache restart](/misc/images/report_images/8_2.png)

##### Воспользоваться *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

- local TCP forwarding
  
- ssh -L local_port:remote_ip:remote_port user@hostname
  
![ssh w22](/misc/images/report_images/8_3.png)

- telnet 127.0.0.1 8888

![telnet 1](/misc/images/report_images/8_4.png)

##### Воспользоваться *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

- Remote TCP forwarding

- Теперь нужно устанавливать ssh-соединение в обратном направлении — от «ws22» к «ws11». Т.е. наша административная рабочая станция будет SSH-сервером и будет доступна по SSH с «ws11», а на «ws11» нужно будет выполнить подключение SSH-клиентом:
  
- ssh -R remote_port:local_ip:local_port user@hostname

![ssh w21](/misc/images/report_images/8_5.png)

![telnet 2](/misc/images/report_images/8_6.png)